---
import { Home, Play, Sparkles, User } from "lucide-react";
import type { LucideIcon } from "lucide-react";

type IconName = "home" | "play" | "ai" | "user";
type UserInfo = { id: string; email: string | null } | null;

interface NavItem {
  label: string;
  mobileLabel?: string;
  href: string;
  icon: IconName;
}

interface Props {
  currentPath: string;
  user?: UserInfo;
}

const navItems: NavItem[] = [
  { label: "Moje fiszki", mobileLabel: "Fiszki", href: "/", icon: "home" },
  { label: "Sesja nauki", mobileLabel: "Nauka", href: "/learn", icon: "play" },
  { label: "Generuj", mobileLabel: "AI", href: "/generate", icon: "ai" },
  { label: "Konto", mobileLabel: "Konto", href: "/account", icon: "user" },
];

const normalizedPath = (path: string) => {
  if (!path) return "/";
  if (path !== "/" && path.endsWith("/")) return path.slice(0, -1);
  return path;
};

const props = Astro.props as Props;
const currentPath = normalizedPath(props.currentPath ?? Astro.url.pathname);
const user = props.user ?? null;
const isAuthenticated = Boolean(user);
const userEmail = user?.email ?? "Brak e-maila";
const isActive = (href: string) => normalizedPath(href) === currentPath;
const navLabel = "Główna nawigacja";
const logoutScript = isAuthenticated
  ? `
(() => {
  const logoutButtons = document.querySelectorAll("[data-nav-logout]");
  if (!logoutButtons.length) return;

  const showToast = (message, tone = "success") => {
    window.dispatchEvent(
      new CustomEvent("aiFlashcards:toast", {
        detail: { message, tone },
      })
    );
  };

  const handleLogout = async (event) => {
    event.preventDefault();
    const target = event.currentTarget;
    target.setAttribute("aria-busy", "true");
    target.disabled = true;

    try {
      const response = await fetch("/api/auth/logout", { method: "POST" });
      if (!response.ok) {
        const payload = await response.json().catch(() => null);
        const message = payload?.error ?? "Nie udało się wylogować";
        throw new Error(message);
      }

      showToast("Wylogowano", "success");
      setTimeout(() => {
        window.location.href = "/auth/login";
      }, 800);
    } catch (error) {
      showToast(
        error instanceof Error ? error.message : "Nie udało się wylogować",
        "error"
      );
      console.error("Nie udało się wylogować", error);
      target.disabled = false;
      target.removeAttribute("aria-busy");
    }
  };

  logoutButtons.forEach((button) => {
    button.addEventListener("click", handleLogout);
  });
})();
`
  : null;

const icons: Record<IconName, LucideIcon> = {
  home: Home,
  play: Play,
  ai: Sparkles,
  user: User,
};
---

<header
  class="sticky top-0 z-40 hidden border-b bg-background/80 backdrop-blur supports-[backdrop-filter]:bg-background/60 md:block"
>
  <div class="mx-auto flex max-w-6xl items-center justify-between px-4 py-3">
    <a class="flex items-center gap-2 text-base font-semibold text-foreground" href="/" aria-label="AI Flashcards">
      <span class="inline-flex size-9 items-center justify-center rounded-lg bg-primary/10 text-primary">AI</span>
      <span class="hidden sm:inline">AI Flashcards</span>
    </a>

    <nav class="flex items-center gap-1" aria-label={navLabel} role="navigation">
      {
        navItems.map((item) => (
          <a
            class={`rounded-md px-3 py-2 text-sm font-medium transition hover:text-foreground ${
              isActive(item.href)
                ? "text-foreground underline decoration-2 underline-offset-[10px]"
                : "text-muted-foreground"
            }`}
            href={item.href}
            aria-current={isActive(item.href) ? "page" : undefined}
          >
            {item.label}
          </a>
        ))
      }

      {
        isAuthenticated ? (
          <div class="ml-2 flex items-center gap-2 border-l pl-3 text-sm">
            <span class="text-xs text-muted-foreground" aria-label={`Zalogowano jako ${userEmail}`}>
              {userEmail}
            </span>
            <button
              type="button"
              class="rounded-md px-3 py-2 font-medium text-muted-foreground transition hover:text-destructive"
              data-nav-logout
              aria-label="Wyloguj"
            >
              Logout
            </button>
          </div>
        ) : null
      }
    </nav>
  </div>
</header>

<nav
  class="fixed inset-x-0 bottom-0 z-40 border-t bg-background/95 shadow-lg backdrop-blur supports-[backdrop-filter]:bg-background/60 md:hidden"
  aria-label={`${navLabel} (mobilna)`}
  role="navigation"
>
  <ul class={`grid ${isAuthenticated ? "grid-cols-5" : "grid-cols-4"}`}>
    {
      navItems.map((item) => (
        <li>
          <a
            class={`flex flex-col items-center gap-1 px-1.5 py-2 text-xs font-medium transition ${
              isActive(item.href) ? "text-primary" : "text-muted-foreground hover:text-foreground"
            }`}
            href={item.href}
            aria-current={isActive(item.href) ? "page" : undefined}
          >
            {(() => {
              const Icon = icons[item.icon];
              return <Icon className="size-5" aria-hidden="true" />;
            })()}
            <span>{item.mobileLabel ?? item.label}</span>
          </a>
        </li>
      ))
    }
    {
      isAuthenticated ? (
        <li>
          <div class="flex flex-col items-center gap-0.5 px-1.5 py-2 text-center">
            <span class="text-[10px] font-medium text-muted-foreground" aria-label={`Zalogowano jako ${userEmail}`}>
              {userEmail}
            </span>
            <button
              type="button"
              class="flex flex-col items-center gap-1 text-xs font-medium text-muted-foreground transition hover:text-destructive"
              data-nav-logout
              aria-label="Wyloguj"
            >
              <span aria-hidden="true">⎋</span>
              <span>Wyloguj</span>
            </button>
          </div>
        </li>
      ) : null
    }
  </ul>
</nav>

{logoutScript ? <script is:inline set:html={logoutScript} /> : null}
