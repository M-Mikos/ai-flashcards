---
import "../styles/global.css";
import SiteNavigation from "../components/navigation/SiteNavigation.astro";

interface Props {
  title?: string;
}

const props = Astro.props as Props;
const title = props.title ?? "AI Flashcards";
const currentPath = Astro.url.pathname;
const user = Astro.locals.user ?? null;
const themeBootScript = `
(() => {
  const STORAGE_KEY = "theme-mode";
  const isValidMode = (value) => value === "light" || value === "dark" || value === "system";
  let storedMode = null;
  try {
    storedMode = localStorage.getItem(STORAGE_KEY);
  } catch {
    storedMode = null;
  }
  const mode = isValidMode(storedMode) ? storedMode : "system";
  const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
  const shouldUseDark = mode === "dark" || (mode === "system" && prefersDark);
  const root = document.documentElement;
  root.classList.toggle("dark", shouldUseDark);
  root.setAttribute("data-theme", shouldUseDark ? "dark" : "light");
  root.style.colorScheme = shouldUseDark ? "dark" : "light";
})();
`;
const toastScript = `
(() => {
  const container = document.getElementById("site-toast-root");
  if (!container) return;

  const classes = {
    success: "border-emerald-200/80 bg-emerald-50 text-emerald-900",
    error: "border-destructive/40 bg-destructive/10 text-destructive",
  };

  let currentToast = null;
  let hideTimeout = 0;

  const removeToast = () => {
    if (currentToast && container.contains(currentToast)) {
      container.removeChild(currentToast);
    }
    currentToast = null;
    clearTimeout(hideTimeout);
  };

  const showToast = (message, tone = "success") => {
    removeToast();
    if (!message) {
      return;
    }

    const toast = document.createElement("div");
    toast.setAttribute("role", "status");
    toast.className =
      "pointer-events-auto flex items-center gap-3 rounded-lg border px-4 py-3 text-sm shadow-md backdrop-blur-sm " +
      (classes[tone] ?? classes.success);

    const content = document.createElement("span");
    content.textContent = message;

    const closeButton = document.createElement("button");
    closeButton.type = "button";
    closeButton.className = "text-sm font-medium text-foreground/80 transition hover:text-foreground";
    closeButton.setAttribute("aria-label", "Zamknij powiadomienie");
    closeButton.textContent = "âœ•";
    closeButton.addEventListener("click", removeToast);

    toast.appendChild(content);
    toast.appendChild(closeButton);
    container.appendChild(toast);
    currentToast = toast;
    hideTimeout = window.setTimeout(removeToast, 4000);
  };

  window.addEventListener("aiFlashcards:toast", (event) => {
    const detail = event.detail ?? {};
    showToast(detail.message ?? "", detail.tone ?? "success");
  });
})();
`;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <script is:inline set:html={themeBootScript} />
  </head>
  <body class="bg-background text-foreground">
    <div class="flex min-h-screen flex-col">
      <SiteNavigation currentPath={currentPath} user={user} />
      <div class="flex-1 pb-16 md:pb-0">
        <slot />
      </div>
    </div>
    <div
      id="site-toast-root"
      aria-live="polite"
      class="pointer-events-none fixed inset-x-0 top-4 z-50 flex justify-center px-4 sm:top-6"
    >
    </div>
    <script is:inline set:html={toastScript} />
  </body>
</html>

<style>
  html,
  body {
    margin: 0;
    width: 100%;
    height: 100%;
  }
</style>
